name: "Monorepo Build and Deploy"

on:
  push:
    branches:
      - staging
      - production

permissions:
  contents: read
  packages: read
  # For OIDC authentication to GCP
  # id-token: write

jobs:
  build_images:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - image_name: main-node
          - image_name: main-python
            cache_path: /root/.cache/uv
    steps:
      # Fetch the last 50 commits so that devops affected works
      - name: Checkout repo and history
        uses: actions/checkout@v4
        with:
          fetch-depth: 50

      - name: Setup prerequesites
        uses: ./.github/actions/common/setup-prereq@v1

      - name: Connect to DigitalOcean K8s
        uses: ./.github/actions/k8s/connect-to-digitalocean-k8s@v1
        with:
          access_token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          cluster_name: ${{ secrets.DIGITALOCEAN_CLUSTER_NAME }}

      - name: Connect to DOCR
        uses: ./.github/actions/registry/connect-to-docr@v1
        with:
          access_token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      # For GCP Artifact Registry with OIDC (alternative to DOCR)
      # - name: Connect to Artifact Registry with OIDC
      #   uses: ./.github/actions/registry/connect-to-artifact-registry-with-oidc@v1
      #   with:
      #     project_id: ${{ vars.GCP_PROJECT_ID }}
      #     project_number: ${{ vars.GCP_PROJECT_NUMBER }}
      #     region: ${{ vars.GCP_ARTIFACT_REGISTRY_REGION }}

      - name: Build image
        uses: ./.github/actions/common/build-image@v1
        with:
          image_name: ${{ matrix.image_name }}
          cache_path: ${{ matrix.cache_path || '/root/.bun/install/cache' }}

  db_migrate_and_deploy:
    needs: [build_images]
    runs-on: ubuntu-latest
    steps:
      # Fetch the last 50 commits so that devops affected works
      - name: Checkout repo and history
        uses: actions/checkout@v4
        with:
          fetch-depth: 50

      - name: Setup prerequesites
        uses: ./.github/actions/common/setup-prereq@v1

      - name: Connect to DigitalOcean K8s
        uses: ./.github/actions/k8s/connect-to-digitalocean-k8s@v1
        with:
          access_token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          cluster_name: ${{ secrets.DIGITALOCEAN_CLUSTER_NAME }}

      - name: Connect to DOCR
        uses: ./.github/actions/registry/connect-to-docr@v1
        with:
          access_token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      # For GCP Artifact Registry with OIDC (alternative to DOCR)
      # - name: Connect to Artifact Registry with OIDC
      #   uses: ./.github/actions/registry/connect-to-artifact-registry-with-oidc@v1
      #   with:
      #     project_id: ${{ vars.GCP_PROJECT_ID }}
      #     project_number: ${{ vars.GCP_PROJECT_NUMBER }}
      #     region: ${{ vars.GCP_ARTIFACT_REGISTRY_REGION }}

      - name: Run DB Migrate
        uses: ./.github/actions/common/db-migrate@v1

      # Repeat per image (it checks if the image is affected and deploys it if it is)
      - name: Deploy main node
        uses: ./.github/actions/common/deploy-image-k8s@v1
        with: { "image_name": "main-node" }

      - name: Deploy main python
        uses: ./.github/actions/common/deploy-image-k8s@v1
        with: { "image_name": "main-python" }
